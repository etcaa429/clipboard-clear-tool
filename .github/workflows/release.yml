name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release Notes
      id: release_notes
      run: |
        echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "## ğŸ‰ ç‰ˆæœ¬ ${{ steps.get_version.outputs.VERSION }} ç™¼å¸ƒ" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“¥ ä¸‹è¼‰æ–¹å¼" >> $GITHUB_OUTPUT
        echo "1. ä¸‹è¼‰ \`ClearClipboard.bat\` æª”æ¡ˆ" >> $GITHUB_OUTPUT
        echo "2. å³éµé¸æ“‡ã€Œä»¥ç³»çµ±ç®¡ç†å“¡èº«åˆ†åŸ·è¡Œã€" >> $GITHUB_OUTPUT
        echo "3. æŒ‰ç…§æç¤ºå®Œæˆå®‰è£" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### âœ¨ ä¸»è¦åŠŸèƒ½" >> $GITHUB_OUTPUT
        echo "- ğŸ–±ï¸ å³éµé¸å–®æ•´åˆ" >> $GITHUB_OUTPUT
        echo "- âš¡ ä¸€éµæ¸…ç©ºå‰ªè²¼ç°¿" >> $GITHUB_OUTPUT
        echo "- ğŸ› ï¸ è‡ªå‹•å®‰è£éƒ¨ç½²" >> $GITHUB_OUTPUT
        echo "- ğŸ”§ å®Œæ•´è§£é™¤å®‰è£æ”¯æ´" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“‹ ç³»çµ±éœ€æ±‚" >> $GITHUB_OUTPUT
        echo "- Windows 7/8/8.1/10/11" >> $GITHUB_OUTPUT
        echo "- .NET Framework 4.0+" >> $GITHUB_OUTPUT
        echo "- ç®¡ç†å“¡æ¬Šé™ï¼ˆå®‰è£æ™‚ï¼‰" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ“ æ›´æ–°å…§å®¹" >> $GITHUB_OUTPUT
        echo "è«‹åƒè€ƒ [CHANGELOG.md](CHANGELOG.md) æŸ¥çœ‹è©³ç´°æ›´æ–°å…§å®¹ã€‚" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### ğŸ†˜ éœ€è¦å”åŠ©ï¼Ÿ" >> $GITHUB_OUTPUT
        echo "- ğŸ“– [ä½¿ç”¨èªªæ˜](README.md)" >> $GITHUB_OUTPUT
        echo "- ğŸ”§ [ç–‘é›£æ’è§£](docs/troubleshooting.md)" >> $GITHUB_OUTPUT
        echo "- ğŸ› [å›å ±å•é¡Œ](https://github.com/${{ github.repository }}/issues)" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create release package
      run: |
        mkdir -p release-package
        cp ClearClipboard.bat release-package/
        cp tools/uninstall.bat release-package/
        cp README.md release-package/
        cp LICENSE release-package/
        cp CHANGELOG.md release-package/
        
        # å»ºç«‹å®‰è£èªªæ˜
        cat > release-package/å®‰è£èªªæ˜.txt << 'EOF'
        Windowså‰ªè²¼ç°¿ä¸€éµæ¸…ç†å·¥å…· - å®‰è£èªªæ˜
        ==========================================
        
        ğŸ“‹ å®‰è£æ­¥é©Ÿï¼š
        1. å³éµé»é¸ã€ŒClearClipboard.batã€
        2. é¸æ“‡ã€Œä»¥ç³»çµ±ç®¡ç†å“¡èº«åˆ†åŸ·è¡Œã€
        3. åœ¨UACæç¤ºä¸­é»é¸ã€Œæ˜¯ã€
        4. ç­‰å¾…å®‰è£å®Œæˆæç¤º
        
        âœ… ä½¿ç”¨æ–¹æ³•ï¼š
        - åœ¨ä»»ä½•æª”æ¡ˆä¸Šå³éµ â†’ ã€Œä¸€éµæ¸…ç†å‰ªè²¼ç°¿ã€
        - åœ¨æ¡Œé¢ç©ºç™½è™•å³éµ â†’ ã€Œä¸€éµæ¸…ç†å‰ªè²¼ç°¿ã€
        
        ğŸ—‘ï¸ è§£é™¤å®‰è£ï¼š
        - ä»¥ç®¡ç†å“¡èº«åˆ†åŸ·è¡Œã€Œuninstall.batã€
        
        ğŸ“ éœ€è¦å”åŠ©ï¼Ÿ
        - æŸ¥çœ‹ README.md æª”æ¡ˆ
        - æˆ–åˆ° GitHub å›å ±å•é¡Œ
        
        ==========================================
        ç‰ˆæœ¬ï¼š${{ steps.get_version.outputs.VERSION }}
        æ›´æ–°æ™‚é–“ï¼š$(date '+%Yå¹´%mæœˆ%dæ—¥')
        EOF
        
        # å»ºç«‹å£“ç¸®æª”
        cd release-package
        zip -r ../clipboard-clear-tool-${{ steps.get_version.outputs.VERSION }}.zip .
        cd ..
        
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        release_name: Windowså‰ªè²¼ç°¿ä¸€éµæ¸…ç†å·¥å…· ${{ steps.get_version.outputs.VERSION }}
        body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        
    - name: Upload Release Asset - ZIP Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./clipboard-clear-tool-${{ steps.get_version.outputs.VERSION }}.zip
        asset_name: clipboard-clear-tool-${{ steps.get_version.outputs.VERSION }}.zip
        asset_content_type: application/zip
        
    - name: Upload Release Asset - Main Script
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./ClearClipboard.bat
        asset_name: ClearClipboard.bat
        asset_content_type: application/octet-stream
        
    - name: Upload Release Asset - Uninstaller
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tools/uninstall.bat
        asset_name: uninstall.bat
        asset_content_type: application/octet-stream